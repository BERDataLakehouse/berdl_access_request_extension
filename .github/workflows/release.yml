name: Release Management

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
    types: [opened, synchronize, reopened, closed]

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install build tools
        run: pip install build jupyterlab

      - name: Set version variables
        id: version
        run: |
          PR_NUMBER="${{ github.event.number }}"

          if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
            # Main branch push (merge) - create stable release
            # Use --exclude "*-*" to ignore pre-release tags (containing hyphens) when finding the last stable tag
            LATEST_TAG=$(git describe --tags --abbrev=0 --match "v*" --exclude "*-*" 2>/dev/null || echo "v0.0.0")
            
            # If no stable tag found (e.g. only alpha tags exist), default to v0.0.0
            if [ -z "$LATEST_TAG" ]; then LATEST_TAG="v0.0.0"; fi
            
            LATEST_VERSION=${LATEST_TAG#v}
            IFS='.' read -r major minor patch <<< "$LATEST_VERSION"
            NEW_PATCH=$((patch + 1))
            VERSION="${major}.${minor}.${NEW_PATCH}"
            TAG_NAME="v${VERSION}"
            RELEASE_NAME="Release v${VERSION}"
            IS_PRERELEASE="false"
            echo "Creating stable release: ${TAG_NAME}"
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            # PR opened/updated - create/update preview release
            # Use 'alpha' which maps cleanly to Python 'a' versions: 0.0.0-alpha.4 -> 0.0.0a4
            VERSION="0.0.0-alpha.${PR_NUMBER}"
            TAG_NAME="v${VERSION}"
            RELEASE_NAME="PR #${PR_NUMBER} Preview"
            IS_PRERELEASE="true"
            echo "Creating/updating preview release for PR #${PR_NUMBER}"
          else
            echo "Skipping version generation"
            exit 0
          fi

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "release_name=${RELEASE_NAME}" >> $GITHUB_OUTPUT
          echo "is_prerelease=${IS_PRERELEASE}" >> $GITHUB_OUTPUT
          echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT

      - name: Update version in package.json
        if: steps.version.outputs.version != ''
        run: |
          npm version --no-git-tag-version "${{ steps.version.outputs.version }}"
          echo "Updated package.json to version ${{ steps.version.outputs.version }}"

      - name: Install dependencies and Build
        run: |
          jlpm install
          jlpm build:lib
          python -m build

      - name: Get Wheel Filename
        id: wheel_file
        if: steps.version.outputs.version != ''
        run: |
          # Capture the actual filename generated by build (handles normalization like -alpha.X -> aX)
          WHEEL_PATH=$(ls dist/*.whl | head -n 1)
          WHEEL_NAME=$(basename $WHEEL_PATH)
          echo "wheel_name=${WHEEL_NAME}" >> $GITHUB_OUTPUT
          echo "Detected wheel: ${WHEEL_NAME}"

      - name: Delete existing PR tag/release (if exists)
        if: github.event_name == 'pull_request'
        run: |
          if git ls-remote --tags origin | grep -q "${{ steps.version.outputs.tag_name }}"; then
            git push --delete origin "${{ steps.version.outputs.tag_name }}" || true
          fi
          gh release delete "${{ steps.version.outputs.tag_name }}" --yes || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete old PR tag when merged
        if: github.event.pull_request.merged == true
        run: |
          # Reconstruct old tag
          OLD_TAG="v0.0.0-alpha.${{ github.event.number }}"
          if git ls-remote --tags origin | grep -q "${OLD_TAG}"; then
            git push --delete origin "${OLD_TAG}" || true
            gh release delete "${OLD_TAG}" --yes || true
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push tag
        if: steps.version.outputs.version != ''
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git tag -d "${{ steps.version.outputs.tag_name }}" 2>/dev/null || true
          git tag -a "${{ steps.version.outputs.tag_name }}" -m "${{ steps.version.outputs.release_name }}"
          git push origin "${{ steps.version.outputs.tag_name }}"

      - name: Create GitHub Release and Upload Assets
        if: steps.version.outputs.version != ''
        run: |
          # Determine body content
          if [ "${{ steps.version.outputs.is_prerelease }}" = "true" ]; then
            BODY="## Preview Release for PR #${{ steps.version.outputs.pr_number }}
            **This is a preview release.**
            
            ### Install Wheel
            \`\`\`bash
            pip install https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag_name }}/${{ steps.wheel_file.outputs.wheel_name }}
            \`\`\`
            "
          else
             BODY="## Release ${{ steps.version.outputs.tag_name }}"
          fi

          gh release create "${{ steps.version.outputs.tag_name }}" \
            --title "${{ steps.version.outputs.release_name }}" \
            --notes "${BODY}" \
            $([ "${{ steps.version.outputs.is_prerelease }}" = "true" ] && echo "--prerelease")

          gh release upload "${{ steps.version.outputs.tag_name }}" dist/* --clobber
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on PR with release info
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const tagName = '${{ steps.version.outputs.tag_name }}';
            const wheelName = '${{ steps.wheel_file.outputs.wheel_name }}';
            const repo = '${{ github.repository }}';
            const wheelUrl = `https://github.com/${repo}/releases/download/${tagName}/${wheelName}`;
            
            const body = `## ðŸ“¦ Preview Release Ready
            
            A preview release has been created for this PR.
            
            ### Usage in pyproject.toml (e.g. spark_notebook_base)
            \`\`\`toml
            berdl-access-request = { git = "https://github.com/${{ github.repository }}.git", rev = "${tagName}" }
            \`\`\`

            ### Manual Install (Source)
            \`\`\`bash
            pip install git+https://github.com/${{ github.repository }}.git@${tagName}
            \`\`\`
            *(Note: Requires npm/jlpm installed to build from source)*

            ### Alternative: Pre-built Wheel
            \`\`\`bash
            pip install ${wheelUrl}
            \`\`\`
            
            ([View Release Assets](https://github.com/${repo}/releases/tag/${tagName}))
            `;

            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existingComment = comments.data.find(comment =>
              comment.user.login === 'github-actions[bot]' &&
              comment.body.includes('Preview Release Ready')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
